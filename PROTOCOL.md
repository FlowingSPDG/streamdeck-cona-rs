# StreamDeck TCP/HID Protocol Specification

## 概要

このドキュメントは、Elgato Stream Deck デバイスの TCP/IP 経由での通信プロトコルおよび USB HID インターフェースの統合仕様書です。

Stream Deck Studio および Stream Deck Plus は、ネットワーク経由で TCP/IP を使用して制御できます。プロトコルは USB HID デバイスのインターフェースを TCP/IP 上でエミュレートしており、以下の2つのモードをサポートしています：

1. **Cora モード**: 新しいプロトコル（Stream Deck Studio などで使用）
2. **Legacy モード**: 後方互換性のための旧プロトコル（Raw Panel プロトコル）

USB 接続デバイス（Stream Deck Mini など）は、USB HID プロトコルを直接使用します。

---

## 目次

1. [TCP 接続仕様](#tcp-接続仕様)
2. [プロトコルモード](#プロトコルモード)
3. [Cora プロトコル](#cora-プロトコル)
4. [Legacy プロトコル](#legacy-プロトコル)
5. [USB HID 実装](#usb-hid-実装)
6. [コマンド仕様](#コマンド仕様)
7. [イベント仕様](#イベント仕様)
8. [デバイス情報取得](#デバイス情報取得)
9. [画像データ送信](#画像データ送信)

---

## TCP 接続仕様

### 接続情報

- **プロトコル**: TCP/IP
- **ポート番号**: `5343`（デフォルト）
- **接続方向**: クライアント（PC/サーバー）→ デバイス（Stream Deck Studio/Plus）
- **タイムアウト**: 5秒（データ未受信時）
- **再接続間隔**: 5秒

### 接続の確立

クライアントは Stream Deck デバイスの IP アドレスとポート（デフォルト: 5343）に TCP 接続を確立します。

```
接続先: <IPアドレス>:5343
```

**重要**: 接続確立後、**サーバー側（デバイス側）が最初にプロトコル固有の keep-alive パケットを送信**します。クライアントはこの受信データの先頭にあるマジックバイトまたはパケット形式でプロトコルモードを検出します。

- **Cora モード**: マジックバイト `[0x43, 0x93, 0x8a, 0x41]` で検出
- **Legacy モード**: パケット `[0x01, 0x0a, ...]` で検出

---

## プロトコルモード

Stream Deck Studio/Plus は、2つの異なるプロトコルモードをサポートしています。接続確立時に、最初のパケットの内容から自動的にプロトコルモードが判定されます。

### プロトコルモード検出

1. **サーバー側（デバイス）**: 接続確立直後にプロトコル固有の keep-alive パケットを送信
2. **クライアント側**: 受信データの先頭でプロトコルモードを検出
   - Cora モード: マジックバイト `[0x43, 0x93, 0x8a, 0x41]`
   - Legacy モード: パケット `[0x01, 0x0a, ...]`
3. **クライアント側**: keep-alive パケットを受信後、ACK レスポンスを送信して接続を確立

### モード比較

| 項目 | Cora モード | Legacy モード |
|------|------------|---------------|
| パケットサイズ | 可変長（16バイトヘッダー + ペイロード） | 固定サイズ（512バイトまたは1024バイト） |
| マジックバイト | `[0x43, 0x93, 0x8a, 0x41]` | なし |
| メッセージID | あり（32bit、リトルエンディアン） | なし |
| Keep-alive レスポンス | 32バイト（Coraメッセージ形式） | 1024バイト（固定パケット） |
| Feature Report送信 | Coraメッセージ形式 | 1024バイト固定パケット |
| HID Write | Coraメッセージ形式 | 1024バイト固定パケット |

---

## Cora プロトコル

### マジックバイト

Cora プロトコルは、4バイトのマジックバイトで識別されます。

- **マジックバイト**: `[0x43, 0x93, 0x8a, 0x41]` (ASCII: "C" + 3バイト)

### メッセージフォーマット

Cora メッセージは以下の構造を持ちます：

```
[16バイトヘッダー][可変長ペイロード]
```

#### ヘッダー構造（16バイト）

| オフセット | サイズ | 説明 |
|-----------|--------|------|
| 0-3 | 4バイト | マジックバイト: `[0x43, 0x93, 0x8a, 0x41]` |
| 4-5 | 2バイト | フラグ（リトルエンディアン） |
| 6 | 1バイト | HID オペレーション |
| 7 | 1バイト | 予約（未使用） |
| 8-11 | 4バイト | メッセージID（リトルエンディアン） |
| 12-15 | 4バイト | ペイロード長（リトルエンディアン） |

### フラグ

| フラグ | 値 | 説明 |
|--------|-----|------|
| VERBATIM | `0x8000` | セカンダリデバイス（Device 2）へのペイロード |
| REQ_ACK | `0x4000` | ホストが ACK を要求 |
| ACK_NAK | `0x0200` | デバイスからの ACK/NAK 応答 |
| RESULT | `0x0100` | GET_REPORT オペレーションへの応答 |
| NONE | `0x0000` | フラグなし |

### HID オペレーション

| オペレーション | 値 | 説明 |
|---------------|-----|------|
| WRITE | `0x00` | HID 書き込み（ボタン画像の送信など） |
| SEND_REPORT | `0x01` | フィーチャーレポート送信（輝度設定など） |
| GET_REPORT | `0x02` | フィーチャーレポート取得（デバイス情報取得など） |

### Keep-Alive メカニズム（Cora モード）

**Keep-alive パケット（デバイス → クライアント）**:
- ペイロード: `[0x01, 0x0a, ...]`
- 接続番号: ペイロードの5バイト目（インデックス5）

**ACK レスポンス（クライアント → デバイス）**:
- フラグ: `ACK_NAK (0x0200)`
- ペイロード: `[0x03, 0x1a, connection_no, ...]` (32バイト)

---

## Legacy プロトコル

### パケットサイズ

Legacy プロトコルは固定サイズのパケットを使用します。

- **受信パケット**: 512 バイト（固定）
- **送信パケット（Feature Report）**: 1024 バイト（固定）
- **送信パケット（Write/Image）**: 1024 バイト（固定）

### パケット識別

Legacy プロトコルは、パケットの先頭2バイトで識別されます。

- **Keep-alive パケット**: `[0x01, 0x0a, ...]` (512バイト)
- **ACK レスポンス**: `[0x03, 0x1a, connection_no, ...]` (1024バイト)

### Keep-Alive メカニズム（Legacy モード）

**Keep-alive パケット（デバイス → クライアント）**:
- パケット: `[0x01, 0x0a, ...]` (512バイト)
- 接続番号: パケットの5バイト目（インデックス5）

**ACK レスポンス（クライアント → デバイス）**:
- パケット: `[0x03, 0x1a, connection_no, ...]` (1024バイト)

### エンディアン

Legacy プロトコル内で使用されるエンディアンは混在しています：

- **Big Endian**: シリアル番号取得時の長さフィールド（オフセット2-3）
- **Little Endian**: その他の数値フィールド（座標、長さ、ページ番号など）

---

## USB HID 実装

USB 接続デバイス（Stream Deck Mini など）は、USB HID プロトコルを直接使用します。

### HID Report Descriptor

```rust
const HID_REPORT_DESCRIPTOR: &[u8] = &[
    // Usage Page (Generic Desktop)
    0x05, 0x01,
    // Usage (Undefined)
    0x09, 0x00,
    // Collection (Application)
    0xa1, 0x01,
    
    // Input Report (Button States: Device → Host)
    0x09, 0x00,                         // Usage (Undefined)
    0x15, 0x00,                         // Logical Minimum (0)
    0x25, 0x01,                         // Logical Maximum (1)
    0x75, 0x08,                         // Report Size (8 bits)
    0x95, STREAMDECK_KEYS as u8,        // Report Count (ボタン数)
    0x81, 0x02,                         // Input (Data, Variable, Absolute)
    
    // Output Report (Image Data: Host → Device)
    0x09, 0x00,                         // Usage (Undefined)
    0x15, 0x00,                         // Logical Minimum (0)
    0x26, 0xFF, 0x00,                   // Logical Maximum (255)
    0x75, 0x08,                         // Report Size (8 bits)
    0x96, 0x00, 0x04,                   // Report Count (1024 bytes)
    0x91, 0x02,                         // Output (Data, Variable, Absolute)
    
    // Feature Report (Commands: Bidirectional)
    0x09, 0x00,                         // Usage (Undefined)
    0x15, 0x00,                         // Logical Minimum (0)
    0x26, 0xFF, 0x00,                   // Logical Maximum (255)
    0x75, 0x08,                         // Report Size (8 bits)
    0x95, HID_REPORT_SIZE_FEATURE as u8, // Report Count (32 bytes)
    0xb1, 0x02,                         // Feature (Data, Variable, Absolute)
    
    // End Collection
    0xc0
];
```

### USB デバイス識別子

| 項目 | 値 |
|------|-----|
| Vendor ID | `0x0fd9` (Elgato) |
| Product ID (Mini) | `0x0063` |
| 製造元 | "Elgato Systems" |
| 製品名 | "Stream Deck Mini" |

---

## コマンド仕様

### Feature Report 送信（SEND_REPORT）

デバイスにコマンドを送信します（例: 輝度設定、リセット）。

#### Cora モード

```typescript
// sendFeatureReport の実装
{
    flags: CoraMessageFlags.VERBATIM,
    hidOp: CoraHidOp.SEND_REPORT,
    messageId: 0,
    payload: Buffer.from(commandData),
}
```

#### Legacy モード

すべてのコマンドパケットは**1024バイト固定**です。ペイロードが短い場合は、残りを0x00でパディングします。

```
[コマンドデータ][0x00パディング] = 1024バイト
```

### 明るさ設定

ボタンの明るさを設定します（0-100%）。

**コマンドパケット**:
```
オフセット | 値 | 説明
---------|-----|------
0        | 0x03 | コマンドタイプ
1        | 0x08 | 明るさ設定コマンド
2        | 0x00-0x64 | 明るさ値（0-100）
3-1023   | 0x00 | パディング
```

### リセットコマンド

デバイスをリセットします（再起動を伴う可能性があります）。

**コマンドパケット**:
```
オフセット | 値 | 説明
---------|-----|------
0        | 0x03 | コマンドタイプ
1        | 0x02 | リセットコマンド
2-1023   | 0x00 | パディング
```

### エンコーダーのLED色設定

エンコーダーのLED色を設定します。

**コマンドパケット**:
```
オフセット | 値 | 説明
---------|-----|------
0        | 0x02 | コマンドタイプ
1        | 0x10 | エンコーダーLED色設定
2        | エンコーダー番号 | エンコーダーインデックス（0または1）
3        | R | 赤成分（0-255）
4        | G | 緑成分（0-255）
5        | B | 青成分（0-255）
6-1023   | 0x00 | パディング
```

### エンコーダーリングのLED色設定

エンコーダーリング（24個のLED）の色を設定します。

**コマンドパケット**:
```
オフセット | 値 | 説明
---------|-----|------
0        | 0x02 | コマンドタイプ
1        | 0x0f | エンコーダーリングLED色設定
2        | エンコーダー番号 | エンコーダーインデックス（0または1）
3-74     | RGBデータ | 24個のLEDのRGB値（各3バイト、合計72バイト）
         |        | エンコーダー1の場合はオフセット0-71
         |        | エンコーダー2の場合はオフセット12-83（12要素オフセット）
75-1023  | 0x00 | パディング
```

---

## 画像データ送信

### ボタン画像の送信

ボタンに画像を表示します。画像は複数のパケットに分割して送信されます。

#### パケットヘッダー構造（Legacy モード）

```
オフセット | 値 | 説明
---------|-----|------
0        | 0x02 | コマンドタイプ
1        | 0x07 | ボタン画像コマンド
2        | ボタンインデックス | ボタン番号（0-31）
3        | 0x00/0x01 | 最終パケットフラグ（0=続きあり、1=最終）
4-5      | 長さ | このパケットのペイロード長（Little Endian, 16bit）
6-7      | ページ番号 | ページ番号（Little Endian, 16bit）
8-1023   | 画像データ | JPEG画像データ + パディング
```

#### パケット送信の流れ

1. 画像を JPEG 形式でエンコード
2. 画像データを複数のパケットに分割（1パケットあたり最大1008バイト）
3. 各パケットにヘッダーを付与して送信
4. 最終パケットのフラグを `0x01` に設定

#### Stream Deck Studio の画像仕様

- **画像形式**: JPEG
- **ボタンサイズ**: 144x112ピクセル
- **1パケットあたりのペイロード**: 1008バイト（ヘッダー8バイト除く）

### エリア画像の送信（エンコーダー上のディスプレイ）

エンコーダーの上にあるディスプレイエリアに画像を表示します。

#### パケットヘッダー構造（Legacy モード）

```
オフセット | 値 | 説明
---------|-----|------
0        | 0x02 | コマンドタイプ
1        | 0x0c | エリア画像コマンド
2-3      | X座標 | 開始X座標（Little Endian, 16bit）
4-5      | Y座標 | 開始Y座標（Little Endian, 16bit、通常0）
6-7      | 幅 | 画像の幅（Little Endian, 16bit）
8-9      | 高さ | 画像の高さ（Little Endian, 16bit）
10       | 0x00/0x01 | 最終パケットフラグ（0=続きあり、1=最終）
11-12    | ページ番号 | ページ番号（Little Endian, 16bit）
13-14    | 長さ | このパケットのペイロード長（Little Endian, 16bit）
15       | 0x00 | パディング
16-1023  | 画像データ | JPEG画像データ + パディング
```

---

## イベント仕様

すべてのイベントパケットは `0x01` で始まります。

### ボタン押下イベント

標準的なボタン（Stream Deck Studioでは32個）の押下/解放イベント。

**イベントパケット**:
```
オフセット | 値 | 説明
---------|-----|------
0        | 0x01 | イベントタイプ
1        | 0x00 | ボタンイベント（または他の値で他のイベントタイプ）
2-3      | 予約 | 予約領域
4-35     | ボタン状態 | 各ボタンの状態（1=押下、0=解放）
36-1023  | 0x00 | パディング
```

**デバウンス**: 100ms のデバウンス時間が実装されています。

### エンコーダーイベント

エンコーダーの回転と押下イベント。

#### エンコーダー回転イベント

**イベントパケット**:
```
オフセット | 値 | 説明
---------|-----|------
0        | 0x01 | イベントタイプ
1        | 0x03 | エンコーダーイベント
2-3      | 予約 | 予約領域
4        | 0x01 | 回転イベント
5-8      | 回転値 | 各エンコーダーの回転値（符号付き8bit、-128〜127）
         |      | 正の値=時計回り、負の値=反時計回り
9-1023   | 0x00 | パディング
```

#### エンコーダー押下イベント

**イベントパケット**:
```
オフセット | 値 | 説明
---------|-----|------
0        | 0x01 | イベントタイプ
1        | 0x03 | エンコーダーイベント
2-3      | 予約 | 予約領域
4        | 0x00 | 押下イベント
5-8      | 押下状態 | 各エンコーダーの押下状態（1=押下、0=解放）
9-1023   | 0x00 | パディング
```

**デバウンス**: 100ms のデバウンス時間が実装されています。

### タッチイベント

タッチスクリーンのタッチイベント。

#### タップ/プレスイベント

**イベントパケット**:
```
オフセット | 値 | 説明
---------|-----|------
0        | 0x01 | イベントタイプ
1        | 0x02 | タッチイベント
2-3      | 予約 | 予約領域
4        | 0x01/0x02 | 0x01=タップ、0x02=プレス/ホールド
5        | 予約 | 予約領域
6-7      | X座標 | タッチ位置X（Little Endian, 16bit）
8-9      | Y座標 | タッチ位置Y（Little Endian, 16bit）
10-1023  | 0x00 | パディング
```

#### スワイプイベント

**イベントパケット**:
```
オフセット | 値 | 説明
---------|-----|------
0        | 0x01 | イベントタイプ
1        | 0x02 | タッチイベント
2-3      | 予約 | 予約領域
4        | 0x03 | スワイプイベント
5        | 予約 | 予約領域
6-7      | X開始 | スワイプ開始X座標（Little Endian, 16bit）
8-9      | Y開始 | スワイプ開始Y座標（Little Endian, 16bit）
10-11    | X終了 | スワイプ終了X座標（Little Endian, 16bit）
12-13    | Y終了 | スワイプ終了Y座標（Little Endian, 16bit）
14-1023  | 0x00 | パディング
```

### NFC イベント

NFC リーダーからのデータ読み取りイベント。

**イベントパケット**:
```
オフセット | 値 | 説明
---------|-----|------
0        | 0x01 | イベントタイプ
1        | 0x04 | NFCイベント
2-3      | 長さ | NFCデータの長さ（Little Endian, 16bit）
4-(4+n)  | NFCデータ | NFC読み取りデータ
(4+n)-1023 | 0x00 | パディング
```

---

## デバイス情報取得

### Feature Report 取得（GET_REPORT）

デバイスから情報を取得します（例: デバイス情報、シリアル番号、ファームウェアバージョン）。

#### Cora モード

**プライマリポートへのリクエスト**:
- フラグ: `NONE (0x0000)`
- ペイロード: `[0x03, reportId]`

**セカンダリポートへのリクエスト**:
- フラグ: `VERBATIM (0x8000)`
- ペイロード: `[reportId]`

#### Legacy モード

**プライマリポートへのリクエスト**:
- パケット: `[0x03, reportId, ...]` (1024バイト)

**セカンダリポートへのリクエスト**:
- パケット: `[reportId, ...]` (1024バイト)

### シリアル番号取得

**リクエスト（クライアント → デバイス）**:
```
オフセット | 値 | 説明
---------|-----|------
0        | 0x03 | コマンドタイプ
1        | 0x84 | リクエストタイプ（シリアル番号取得）
2-1023   | 0x00 | パディング
```

**レスポンス（デバイス → クライアント）**:
```
オフセット | 値 | 説明
---------|-----|------
0        | 0x03 | コマンドタイプ
1        | 0x84 | レスポンスタイプ（シリアル番号）
2-3      | 長さ  | シリアル番号の長さ（Big Endian, 16bit）
4-(4+n)  | 文字列 | シリアル番号（ASCII文字列）
(4+n)-1023 | 0x00 | パディング
```

**注意**: シリアル番号取得時の長さフィールドは **Big Endian** です（他のフィールドは通常 Little Endian）。

### その他の情報取得コマンド

| Report ID | 説明 |
|-----------|------|
| `0x81` | バージョン番号（1.00.002） |
| `0x82` | バージョン番号（1.05.004） |
| `0x83` | ファームウェアバージョン取得 |
| `0x84` | シリアル番号取得 |
| `0x85` | MAC アドレス取得 |
| `0x86` | エンコーダー AP2 ファームウェアバージョン取得 |
| `0x87` | その他の情報（Buttonsアプリが使用） |
| `0x8a` | エンコーダー LD ファームウェアバージョン取得 |
| `0x1c` | セカンダリデバイス（Device 2）情報取得 |

### プライマリポート情報取得

**レポートID**:
- **プライマリポート**: `0x80`
- **セカンダリポート**: `0x08`

**レスポンス構造**:
- オフセット 12-13: Vendor ID（リトルエンディアン）
- オフセット 14-15: Product ID（リトルエンディアン）

### セカンダリデバイス情報取得

Stream Deck Studio は、USB ポートに接続されたセカンダリデバイス（Device 2）の情報を取得できます。

**レポートID**: `0x1c`

**レスポンス構造**:
- オフセット 4: ステータス（`0x02` = 接続済み）
- オフセット 26-27: Vendor ID（リトルエンディアン）
- オフセット 28-29: Product ID（リトルエンディアン）
- オフセット 94-124: シリアル番号（ASCII、null終端）
- オフセット 126-127: TCP ポート番号（リトルエンディアン）

---

## プライマリ/セカンダリポート

Stream Deck Studio は、複数の TCP ポートを持つ場合があります：

- **プライマリポート**: Stream Deck Studio 本体の制御
- **セカンダリポート**: USB ポートに接続されたセカンダリデバイス（Device 2）の制御

セカンダリポートの情報は、プライマリポートから取得できます。

### ポートの識別

- **プライマリポート**: Feature Report で `0x03` プレフィックスを使用
- **セカンダリポート**: Feature Report でプレフィックスなし（または `VERBATIM` フラグ）

---

## デバイス発見（mDNS/Bonjour）

Stream Deck Studio/Plus は、mDNS/Bonjour を使用してネットワーク上で自動発見されます。

### mDNS サービス情報

- **サービスタイプ**: `elg._tcp`
- **クエリ間隔**: 10秒（デフォルト）

### mDNS TXT レコード

| キー | 説明 |
|------|------|
| `dt` | デバイスタイプ（215 = Network Dock） |
| `vid` | Vendor ID |
| `pid` | Product ID |
| `sn` | シリアル番号 |

---

## 接続管理

### 自動再接続

接続が切断された場合、自動的に再接続を試みます。

- **再接続間隔**: 5秒

### タイムアウト処理

- **タイムアウト時間**: 5秒（データ未受信時）
- **タイムアウト時**: 接続を切断し、自動再接続を開始

---

## 実装参考

### 実装ファイル

#### @elgato-stream-deck/tcp パッケージ（TypeScript/Node.js）

- **定数**: `packages/tcp/src/constants.ts`
- **ソケットラッパー**: `packages/tcp/src/socketWrapper.ts`
- **TCP ラッパー**: `packages/tcp/src/tcpWrapper.ts`
- **接続管理**: `packages/tcp/src/connectionManager.ts`
- **デバイス発見**: `packages/tcp/src/discoveryService.ts`
- **HID デバイス（Cora）**: `packages/tcp/src/hid-device/cora.ts`
- **HID デバイス（Legacy）**: `packages/tcp/src/hid-device/legacy.ts`
- **デバイス情報**: `packages/tcp/src/device2Info.ts`

#### streamdeck-rs-tcp（Rust）

- **接続管理**: `src/connection.rs`
- **プロトコル**: `src/protocol/`
- **デバイス実装**: `src/device/`

#### productiondeck（Rust/Embassy）

- **USB HID**: `src/usb.rs`
- **設定**: `src/config.rs`
- **デバイス実装**: `src/device/`

---

## まとめ

Stream Deck の TCP/HID プロトコルは、以下の特徴を持ちます：

### TCP 接続（Stream Deck Studio/Plus）

1. **ポート番号**: TCP ポート 5343（デフォルト）
2. **プロトコルモード**: Cora（新規）と Legacy（後方互換）の2つ
3. **Keep-alive**: デバイスから定期的に送信され、クライアントが応答
4. **タイムアウト**: 5秒間データが受信されないと切断
5. **自動再接続**: 切断時に5秒間隔で再接続を試みる
6. **mDNS 発見**: Bonjour/mDNS を使用してネットワーク上のデバイスを自動発見
7. **プライマリ/セカンダリポート**: 複数のポートをサポートし、セカンダリデバイスを制御可能

### Legacy プロトコル

1. **固定パケットサイズ**: すべてのパケットは1024バイト（送信）または512バイト（受信）
2. **ポート**: 5343
3. **キープアライブ**: 5秒以内に応答が必要
4. **コマンドタイプ**: 
   - `0x01`: イベント（デバイス→クライアント）
   - `0x02`: 画像/LED制御（クライアント→デバイス）
   - `0x03`: 設定/情報取得（クライアント→デバイス）
5. **エンディアン**: Big Endian（シリアル番号長さ）とLittle Endian（その他）が混在

### Cora プロトコル

1. **可変長メッセージ**: 16バイトヘッダー + 可変長ペイロード
2. **マジックバイト**: `[0x43, 0x93, 0x8a, 0x41]`
3. **メッセージID**: 32bit（リトルエンディアン）
4. **フラグ**: VERBATIM, REQ_ACK, ACK_NAK, RESULT
5. **HID オペレーション**: WRITE, SEND_REPORT, GET_REPORT

### USB HID（Stream Deck Mini など）

1. **HID Report Descriptor**: Input/Output/Feature レポートを定義
2. **USB デバイス識別**: Vendor ID `0x0fd9`, Product ID `0x0063`（Mini）
3. **レポートサイズ**: Input（ボタン数バイト）、Output（1024バイト）、Feature（32バイト）

このプロトコルは、USB HID デバイスのインターフェースを TCP 上でエミュレートし、USB 接続と同じ API を使用してデバイスを制御できるようにしています。
